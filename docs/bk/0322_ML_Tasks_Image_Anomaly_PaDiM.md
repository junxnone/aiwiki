-----

| Title     | ML Tasks Image Anomaly PaDiM                          |
| --------- | ----------------------------------------------------- |
| Created @ | `2022-12-05T01:58:43Z`                                |
| Updated @ | `2025-05-26T09:17:07Z`                                |
| Labels    | \`\`                                                  |
| Edit @    | [here](https://github.com/junxnone/aiwiki/issues/322) |

-----

# PaDiM

  - PaDiM - `Patch Distribution Modeling`
  - 核心流程围绕 “特征提取 - 分布建模 - 异常评分” 展开，结合预训练 CNN 与概率统计方法实现异常检测与定位。
  - 使用预训练的 CNN 网络提取中间层feature 组成嵌入向量
  - 使用随机选择来降低维数，去除冗余信息
  - **仅正常类的学习** =\> `构建正常类特征`
  - 对训练集中正常图片相应的 `patch` 建模高斯分布, 作为正常特征
  - 计算 `Anomaly Map` - 待测试图片与正常类特征计算相似度
      - 对待测试图片计算特征向量，根据 `Mahalanobis Distance` 马氏距离计算`相应patch`的异常分数

## Arch

![image](media/119682f034642649c2910ef49b008d65f6cbd1b6.png)

    训练阶段：
    正常图像 → 分块 → 预训练CNN提取多層特征 → 拼接特征 → 随机降维（可选）→ 计算各位置高斯分布参数(μ, Σ)
    
    测试阶段：
    测试图像 → 分块 → 提取特征并降维 → 对每个补丁计算马氏距离 → 生成异常热图 → 全局异常评分

### 训练阶段：构建正常模式的概率模型

#### 1\. 图像分块与特征提取

  - **输入**：仅使用正常类图像（单类学习设定）。
  - **分块**：将图像划分为多个重叠或非重叠的补丁（patch），每个补丁对应原始图像的局部区域。
  - **特征提取**：通过预训练CNN（如ResNet、EfficientNet）提取不同层的激活值，例如：
      - 对ResNet18，提取前3层（Layer1-Layer3）的特征，融合低层级（边缘、纹理）和高层级（语义结构）信息。
      - 对EfficientNet-B5，提取第7、20、26层的特征，平衡分辨率与语义信息。
  - **特征融合**：将不同层的特征拼接，形成每个补丁的高维嵌入向量（如ResNet18拼接后为448维）。

#### 2\. 降维优化（可选）

  - **问题**：高维特征可能包含冗余信息，增加计算复杂度。
  - **方法**：采用**随机特征选择（Rd）** 而非PCA，随机选取部分维度（如100维），实验证明此方法更高效且性能损失极小。

#### 3\. 高斯分布建模

  - 对每个补丁位置 $(i,j)$ （对应CNN特征图的空间坐标），收集所有训练图像中该位置的嵌入向量集合 $X\_{ij}$ 。
  - 假设 $X\_{ij}$ 服从多元高斯分布 $\\mathcal{N}(\\mu\_{ij}, \\Sigma\_{ij})$ ，计算：
      - 均值 $\\mu\_{ij}$ ：该位置所有训练特征的平均值。
      - 协方差矩阵 $\\Sigma\_{ij}$ ：考虑特征间的相关性，并添加正则项 $\\epsilon I$ 保证矩阵可逆。
  - **输出**：每个位置的高斯分布参数 $(\\mu\_{ij}, \\Sigma\_{ij})$ ，构成“正常模式”的概率模型。

### 测试阶段：生成异常热图与评分

#### 1\. 测试图像特征提取

  - 对测试图像同样分块，通过相同预训练CNN提取特征，拼接后得到各补丁的嵌入向量 $x\_{ij}$ 。
  - 若训练阶段使用降维，测试时对特征进行相同的随机维度选择。

#### 2\. 马氏距离计算异常分数

  - 对每个补丁 $x\_{ij}$ ，计算其与对应高斯分布的**马氏距离**：
    
    $$M(x\_{ij}) = \\sqrt{(x\_{ij} - \\mu\_{ij})^T \\Sigma\_{ij}^{-1}
    (x\_{ij} - \\mu\_{ij})}$$
    
      - 距离越大，说明该补丁偏离正常模式的程度越高，异常可能性越大。

#### 3\. 生成异常热图与全局评分

  - **异常热图**：将所有补丁的马氏距离映射为图像像素的颜色值（如黄色表示高分异常，蓝色表示正常），直观显示异常位置。
  - **图像级异常分数**：取热图中的最大值作为整幅图像的异常分数，用于判断图像是否存在异常。

## Reference

  - [PaDiM: a Patch Distribution Modeling Framework for Anomaly
    Detection and Localization](https://arxiv.org/pdf/2011.08785.pdf)
